# 代码审查 Round 4 — Phase 5.6 深色模式

> **审查日期**: 2026-02-19  
> **审查范围**: Phase 5.6 深色模式实现  
> **审查结论**: 4 个问题，全部修复  

---

## 发现与修复

### 1. CSS 规则重复 — dark/auto 双套规则冗余

**问题**:  
`[data-theme="dark"]` 和 `@media (prefers-color-scheme: dark)` 两处分别定义了相同的 CSS 变量覆盖，导致样式文件膨胀、维护困难。

**修复**:  
JS 初始化时统一为 `[data-dark]` 属性（无论用户选深色还是 auto+系统深色），CSS 只保留 `[data-dark]` 一套规则。

---

### 2. 滥用 `!important` — 优先级污染

**问题**:  
深色模式覆盖规则中多处使用 `!important`，导致后续样式难以覆盖，调试困难。

**修复**:  
整理选择器特异性，使 `[data-dark]` 规则自然优先，移除全部 `!important` 声明。

---

### 3. scroll 事件未节流 — 主线程阻塞风险

**问题**:  
设置页滚动监听直接在 `scroll` 事件中执行 DOM 操作，高频触发可能导致掉帧。

**修复**:  
用 `requestAnimationFrame` 包裹回调，每帧最多执行一次，消除不必要的主线程压力。

---

### 4. 主题切换逻辑分散 — `auto` 模式系统变化未响应

**问题**:  
`auto` 模式下，用户切换系统主题时，页面未动态响应（`prefers-color-scheme` 变化未监听）。

**修复**:  
添加 `matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ...)` 监听，`auto` 模式下实时跟随系统切换 `[data-dark]` 属性。

---

## 总结

| # | 类型 | 严重性 | 状态 |
|---|------|--------|------|
| 1 | CSS 架构 | 🟡 中 | ✅ 已修复 |
| 2 | CSS 质量 | 🟡 中 | ✅ 已修复 |
| 3 | 性能 | 🟡 中 | ✅ 已修复 |
| 4 | 功能完整性 | 🟠 高 | ✅ 已修复 |
